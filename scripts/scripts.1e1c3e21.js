"use strict";angular.module("photomapApp",["ngRoute","ngTouch","ngStorage","afOAuth2","uiGmapgoogle-maps","cgBusy"]).config(["$routeProvider","uiGmapGoogleMapApiProvider",function(a,b){b.configure({v:"3.17",libraries:"weather,geometry,visualization"}),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",requireToken:!0}).when("/album/:userid-:albumid",{templateUrl:"views/album.html",controller:"AlbumCtrl",requireToken:!0}).otherwise({redirectTo:"/"})}]),angular.module("photomapApp").controller("MainCtrl",["$scope","AccessToken","$http","uiGmapGoogleMapApi","$rootScope",function(a,b,c,d,e){a.isLogin=null!=b.get(),e.album=null,a.isLogin&&(a.myPromise=c.jsonp("https://picasaweb.google.com/data/feed/api/user/default",{params:{callback:"JSON_CALLBACK",alt:"json-in-script",access_token:b.get().access_token}}).success(function(b){a.albums=b.feed.entry}))}]),angular.module("photomapApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("photomapApp").controller("AlbumCtrl",["$scope","AccessToken","$http","uiGmapGoogleMapApi","$rootScope","$routeParams",function(a,b,c,d,e,f){a.photos=[],a.map={fit:!0,center:{latitude:59,longitude:18},zoom:8,options:{panControl:!1,rotateControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!1},events:{tilesloaded:function(b){a.$apply(function(){console.log("this is the map instance"),a.maps=b})},drag:function(b){a.updateLine()},zoom_changed:function(b){a.updateLine()},center_changed:function(b){a.updateLine()}}},d.then(function(d){a.myPromise=c.jsonp("https://picasaweb.google.com/data/feed/api/user/"+f.userid+"/albumid/"+f.albumid,{params:{callback:"JSON_CALLBACK",alt:"json-in-script",access_token:b.get().access_token}}).success(function(b){for(var c in b.feed.entry){var d=b.feed.entry[c];if(d.georss$where){var f=d.georss$where.gml$Point.gml$pos.$t.split(" ");try{a.photos.push({id:d.gphoto$id.$t,latitude:parseFloat(f[0]),longitude:parseFloat(f[1]),icon:"http://maps.google.com/mapfiles/marker.png",content:{title:d.title.$t,time:d.exif$tags.exif$time.$t,image:d.content.src,thumbnail:d.media$group.media$thumbnail[0].url}})}catch(g){console.log(d.gphoto$id.$t+" failed with "+g)}}}e.album={title:b.feed.title.$t,count:a.photos.length},console.log(a.map)})}),a.windowOptions={show:!1},a.onClick=function(b){var c=b.model?b.model:b;a.windowOptions.show=!0,a.windowOptions.coords={latitude:c.latitude,longitude:c.longitude},a.windowOptions.content=c.content,a.map.zoom=16,a.map.center=a.windowOptions.coords},a.closeClick=function(){a.windowOptions.show=!1},a.hoverState=function(b,c,d){a.map.target=d?$(b.target):null,a.map.fit=!1,a.map.center;for(var e in a.photos)if(a.photos[e].id==c.id){a.map.current=d?a.photos[e]:null,a.photos[e].icon=d?"http://maps.google.com/mapfiles/marker_green.png":"http://maps.google.com/mapfiles/marker.png",a.updateLine();break}},a.updateLine=function(){if(null==a.map.current||null==a.map.target)return void $(".line").remove();var b=Math.pow(2,a.maps.getZoom()),c=new google.maps.LatLng(a.maps.getBounds().getNorthEast().lat(),a.maps.getBounds().getSouthWest().lng()),d=a.maps.getProjection().fromLatLngToPoint(c),e=a.maps.getProjection().fromLatLngToPoint(new google.maps.LatLng(a.map.current.latitude,a.map.current.longitude)),f=new google.maps.Point(Math.floor((e.x-d.x)*b),Math.floor((e.y-d.y)*b));a.createLine(f.x,f.y-27,a.map.target.offset().left+a.map.target.outerWidth(!0)/2,a.map.target.offset().top+a.map.target.outerHeight(!0)/2)},a.createLine=function(a,b,c,d){var e=Math.sqrt((a-c)*(a-c)+(b-d)*(b-d)),f=180*Math.atan2(d-b,c-a)/Math.PI,g="rotate("+f+"deg)";$(".line").remove();var h=$("<div>").appendTo("body").addClass("line").css({position:"absolute",transform:g}).width(e).offset({left:a,top:b});return h}}]);