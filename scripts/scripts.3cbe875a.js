"use strict";angular.module("photomapApp",["ngRoute","ngTouch","ngStorage","uiGmapgoogle-maps","cgBusy","afOAuth2"]).config(["$routeProvider","uiGmapGoogleMapApiProvider",function(a,b){b.configure({v:"3.17",libraries:"weather,geometry,visualization"}),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:access_token?",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/album/:provider",{templateUrl:"views/album.html",controller:"AlbumCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/map/:provider/:albumid",{templateUrl:"views/map.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]).factory("localFiles",function(){return{}}),angular.module("photomapApp").controller("AlbumCtrl",["$scope","AccessToken","$rootScope","ApiWrapper","uiGmapGoogleMapApi","$routeParams",function(a,b,c,d,e,f){a.isLogin=null!=b.set(),a.provider=f.provider,a.isLogin&&(c.photos=null,a.myPromise=d.get(f.provider).getAlbum(b.get().access_token).then(function(b){a.albums=b,c.albums={title:f.provider,count:a.albums.length}}))}]),angular.module("photomapApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("photomapApp").controller("MapCtrl",["$scope","AccessToken","$http","uiGmapGoogleMapApi","$rootScope","$routeParams","ApiWrapper","localFiles",function(a,b,c,d,e,f,g,h){a.photos=[],a.map={fit:!0,center:{latitude:59,longitude:18},zoom:8,options:{panControl:!1,rotateControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!1},events:{tilesloaded:function(b){a.$apply(function(){a.maps=b})},drag:function(b){a.updateLine()},zoom_changed:function(b){a.updateLine()},center_changed:function(b){a.updateLine()}}};var i=function(a){for(var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})};a.readPhoto=function(b){var c=new FileReader;c.onloadend=function(b){return function(c){var d=new JpegMeta.JpegFile(atob(c.target.result.replace(/^.*?,/,"")),b),f=new Image;if(f.src=c.target.result,"0000:00:00"!=d.gps.GPSDateStamp.value){var g=i(c.target.result),h=window.URL.createObjectURL(g);a.photos.push({id:d.filename.name,latitude:parseFloat(d.gps.latitude.value),longitude:parseFloat(d.gps.longitude.value),icon:"images/maps/dot_red.png",content:{title:d.filename.name,time:d.filename.lastModified,image:h,thumbnail:h}}),e.photos.count=a.photos.length,a.$apply()}}}(b),c.readAsDataURL(b)},d.then(function(c){f.albumid.split("-");if("local"==f.provider){e.photos={title:"Local",count:0},a.photos=[];for(var d=0;d<h.files.length;d++)!function(b){a.readPhoto(b)}(h.files[d])}else a.myPromise=g.get(f.provider).getPhotos(b.set().access_token,f.albumid).then(function(b){e.photos={title:b.title,count:b.photos.length},a.photos=b.photos})}),a.windowOptions={show:!1},a.onClick=function(b){var c=b.model?b.model:b;a.windowOptions.show=!0,a.windowOptions.coords={latitude:c.latitude,longitude:c.longitude},a.windowOptions.content=c.content,a.map.zoom=16,a.map.center=a.windowOptions.coords},a.closeClick=function(){a.windowOptions.show=!1},a.hoverState=function(b,c,d){a.map.target=d?$(b.target):null,a.map.fit=!1,a.map.center;for(var e in a.photos)if(a.photos[e].id==c.id){a.map.current=d?a.photos[e]:null,a.photos[e].icon=d?"images/maps/dot_green.png":"images/maps/dot_red.png",a.updateLine();break}},a.updateLine=function(){if(null==a.map.current||null==a.map.target)return void $(".line").remove();var b=Math.pow(2,a.maps.getZoom()),c=new google.maps.LatLng(a.maps.getBounds().getNorthEast().lat(),a.maps.getBounds().getSouthWest().lng()),d=a.maps.getProjection().fromLatLngToPoint(c),e=a.maps.getProjection().fromLatLngToPoint(new google.maps.LatLng(a.map.current.latitude,a.map.current.longitude)),f=new google.maps.Point(Math.floor((e.x-d.x)*b),Math.floor((e.y-d.y)*b));a.createLine(f.x,f.y-7,a.map.target.offset().left+a.map.target.outerWidth(!0)/2,a.map.target.offset().top+a.map.target.outerHeight(!0)/2)},a.createLine=function(a,b,c,d){var e=Math.sqrt((a-c)*(a-c)+(b-d)*(b-d)),f=180*Math.atan2(d-b,c-a)/Math.PI,g="rotate("+f+"deg)";$(".line").remove();var h=$("<div>").appendTo("body").addClass("line").css({position:"absolute",transform:g}).width(e).offset({left:a,top:b});return h}}]),angular.module("photomapApp").factory("ApiWrapper",["$q","$http",function(a,b){var c={};return c.google={getAlbum:function(c){return a(function(a,d){b.jsonp("https://picasaweb.google.com/data/feed/api/user/default",{params:{callback:"JSON_CALLBACK",alt:"json-in-script",access_token:c}}).success(function(b){var c=[];for(var d in b.feed.entry){var e=b.feed.entry[d];c.push({title:e.title.$t,url:e.gphoto$user.$t+"-"+e.gphoto$id.$t,count:e.gphoto$numphotos.$t,author:e.author[0].name.$t,date:e.gphoto$timestamp.$t,image:e.media$group.media$content[0].url})}a(c)})})},getPhotos:function(c,d){return a(function(a,e){var f=d.split("-");b.jsonp("https://picasaweb.google.com/data/feed/api/user/"+f[0]+"/albumid/"+f[1],{params:{callback:"JSON_CALLBACK",alt:"json-in-script",access_token:c}}).success(function(b){var c={title:b.feed.title.$t,photos:[]};for(var d in b.feed.entry){var e=b.feed.entry[d];if(e.georss$where){var f=e.georss$where.gml$Point.gml$pos.$t.split(" ");try{c.photos.push({id:e.gphoto$id.$t,latitude:parseFloat(f[0]),longitude:parseFloat(f[1]),icon:"images/maps/dot_red.png",content:{title:e.title.$t,time:e.exif$tags.exif$time.$t,image:e.content.src,thumbnail:e.media$group.media$thumbnail[0].url}})}catch(g){console.log(e.gphoto$id.$t+" failed with "+g)}}}a(c)})})}},c.facebook={getAlbum:function(c){return a(function(a,d){b.jsonp("https://graph.facebook.com/v2.3/me/albums",{params:{callback:"JSON_CALLBACK",alt:"json-in-script",access_token:c}}).success(function(b){var d=[];for(var e in b.data){var f=b.data[e];d.push({title:f.name,url:f.id,count:f.count,author:f.from.name,date:f.updated_time,image:"https://graph.facebook.com/v2.3/"+f.cover_photo+"/picture?access_token="+c})}a(d)})})},getPhotos:function(c,d){return a(function(a,e){d.split("-");b.jsonp("https://graph.facebook.com/v2.3/"+d+"/photos",{params:{"with":"location",callback:"JSON_CALLBACK",alt:"json-in-script",access_token:c}}).success(function(b){var c={title:"TODO",photos:[]};for(var d in b.data){var e=b.data[d];if(e.place)try{c.photos.push({id:e.id,latitude:parseFloat(e.place.location.latitude),longitude:parseFloat(e.place.location.longitude),icon:"images/maps/dot_red.png",content:{title:e.name,time:e.created_time,image:e.picture,thumbnail:e.picture}})}catch(f){console.log(e.gphoto$id.$t+" failed with "+f)}}a(c)})})}},{list:function(){return{google:{url:"https://accounts.google.com/o/oauth2/auth",client:"707577585652-pp5ln39kak6l51u67eisikv4q3nftbhs.apps.googleusercontent.com",scope:"https://picasaweb.google.com/data/"},facebook:{url:"https://www.facebook.com/dialog/oauth",client:"1003686156322671",scope:"user_photos"}}},get:function(a){return c[a]}}}]),angular.module("photomapApp").controller("MainCtrl",["$scope","$rootScope","ApiWrapper","$routeParams","AccessToken","$location",function(a,b,c,d,e,f){b.albums=null,b.photos=null,a.services=c.list();var g=e.set();g&&g.state&&d.access_token&&f.url("/album/"+g.state),a.dropped=function(){console.log("files dropped"),f.url("/map/local/dropped"),a.$apply()}}]).directive("dropzone",["localFiles",function(a){return{restrict:"A",link:function(b,c){var d=angular.element('<input type="file" style="display: none" multiple />');c.append(d),c.get(0).addEventListener("dragover",function(a){c.addClass("drag-hover"),a.dataTransfer.dropEffect="link",a.preventDefault()}),c.get(0).addEventListener("dragleave",function(a){c.removeClass("drag-hover")}),c.get(0).addEventListener("drop",function(d){d.stopPropagation(),d.preventDefault(),c.removeClass("drag-hover"),a.files=d.dataTransfer.files,b.dropped()}),c.get(0).addEventListener("click",function(a){d.trigger("click")}),d.get(0).addEventListener("change",function(c){a.files=c.target.files,b.dropped()})}}}]);